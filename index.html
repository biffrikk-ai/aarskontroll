<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Årskontroll – Web</title>
  <style>
    :root{--bg:#f6f9ff;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#5aa8ff;--stroke:#e2e8f0;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .appbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px;background:linear-gradient(180deg,#eaf3ff,#ffffff);border:1px solid var(--stroke);border-radius:18px;padding:14px 16px;box-shadow:0 4px 16px rgba(16,24,40,.06)}
    h1{font-size:22px;margin:0;font-weight:800}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;box-shadow:0 2px 8px rgba(63,144,242,.25);cursor:pointer}
    .btn.secondary{background:#fff;color:#0f172a;border:1px solid var(--stroke)}
    .btn.danger{background:#ef4444}
    .grid{display:grid;gap:14px}
    @media(min-width:960px){.grid.two{grid-template-columns:1.2fr .8fr}}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:16px;padding:16px;box-shadow:0 4px 16px rgba(16,24,40,.06)}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .input, select, textarea{width:100%;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff}
    .row{display:grid;gap:12px}
    @media(min-width:720px){.row.two{grid-template-columns:1fr 1fr} .row.three{grid-template-columns:1fr 1fr 1fr}}
    .kundeitem{display:flex;justify-content:space-between;align-items:flex-start;padding:12px;border:1px solid var(--stroke);border-radius:14px;background:#fff}
    .kundeitem:hover{background:#fafcff}
    .small{color:var(--muted);font-size:12px}
    .divider{height:1px;background:var(--stroke);margin:10px 0}
    .thumb{width:140px;height:100px;object-fit:cover;border:1px solid var(--stroke);border-radius:8px}

    /* Avhukingsbokser (radio som ser ut som bokser) */
    .choices{display:flex;gap:8px;flex-wrap:wrap}
    .choice{position:relative}
    .choice input{position:absolute;opacity:0;pointer-events:none}
    .choice label{
      display:inline-block; border:1px solid var(--stroke); border-radius:10px; padding:8px 12px; cursor:pointer; user-select:none;
      background:#fff; min-width:110px; text-align:center; font-weight:600;
    }
    .choice input:checked + label{border-color:#5aa8ff; box-shadow:0 0 0 3px rgba(90,168,255,.2)}
    .choice.ok input:checked + label{background:#eaf6ff}
    .choice.warn input:checked + label{background:#ffecec; border-color:#ef4444; color:#b91c1c}
  </style>
</head>
<body>
  <div class="container">
    <div class="appbar">
      <h1>Årskontroll – Web</h1>
      <div style="flex:1"></div>
    </div>
    <div id="root">Laster…</div>
  </div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
  (function(){
    const React = window.React, ReactDOM = window.ReactDOM;
    const { jsPDF } = (window.jspdf||{});
    const e = React.createElement, F = React.Fragment;

    // ===== Helpers & data =====
    const LS="aarskontroll_store_v29";
    const load=()=>{try{return JSON.parse(localStorage.getItem(LS)||"{}")}catch{return{}}};
    const debouncedSave=(()=>{let t=null;return s=>{clearTimeout(t);t=setTimeout(()=>localStorage.setItem(LS,JSON.stringify(s)),300)}})();
    const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
    const today=()=>new Date().toISOString().slice(0,10);
    const cleanType=(t="")=>String(t).replace(/EN\s*\d+(\s*\/\s*EN\d+)*/gi,"").replace(/[–-]\s*/g,"").trim();
    const readFileAsDataURL=f=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f)});

    const CHECKLISTS={
      "EN361 / EN358 / EN813 – Sele":[
        "Merkelapp/ID lesbar og samsvarer med standard","Bånd/stropper uten kutt, rifter, oppflising eller misfarging",
        "Sømmer intakte – ingen løse tråder","D-ringer/spenner uten rust/deformasjon/skarpe kanter",
        "Justeringspunkter fungerer og holder posisjon","Polstring/festepunkter i god stand",
        "Produsentens etikett/sertifisering lesbar","Utstyr rent/tørt/korrekt lagret","Ingen tegn til overbelastning/fall/modifikasjon"
      ],
      "EN355 – Fangline / Falldemper":[
        "Merkelapp/ID lesbar – EN355","Falldemper ikke utløst/forlenget","Line uten kutt/slitasje/UV/kjemisk skade",
        "Sømmer/termineringer hele","Kroker/karabiner lukker og ikke deformert","Visuell fallindikator ikke aktivert","Lengde og type passer bruksområdet"
      ],
      "EN360 – Fallblokk":[
        "Merkelapp lesbar – EN360","Hus uten sprekker/deformasjon/skade","Wire/bånd uten rust/oppflising/kutt/bøying",
        "Innspoling jevn uten rykk","Brems løser normalt ved trekkprøve","Krok med sikkerhetslås ok","Fallindikator viser ikke utløsning","Siste kontrollmerke oppdatert"
      ],
      "EN353-2 – Linesystem / Vertikal line":[
        "Merkelapp og produsentinfo lesbar – EN353-2","Wire/tau uten kutt/slitasje/oppflising/rust",
        "Løpevogn beveger seg fritt og låser ved falltest","Koblingspunkter og kroker fungerer",
        "Forankringspunkt korrekt og uten skade","Endefester intakte og ikke rustne","System komplett iht. spesifikasjon"
      ],
      "EN358 – Støttesystem":[
        "Merkelapp/ID samsvarer med EN358","Tau/belte uten kutt/rifter/UV/kjemisk påvirkning",
        "Justeringsmekanismer fungerer og holder","Kroker/karabiner lukker og låser korrekt",
        "Sømmer/termineringer uten skade","Bruksområde/merking samsvarer med bruk"
      ],
      "EN354 – Forbindelsesline":[
        "Merkelapp lesbar – EN354","Tau uten kutt/rifter/UV/kjemisk skade","Endefester/sømmer intakte",
        "Kroker fungerer og lukker korrekt","Lengde/type samsvarer med bruk"
      ],
      "EN795 – Forankringsanordning":[
        "Merkelapp og produsentinfo lesbar – EN795","Forankringspunkt fast – uten sprekker/rust/deformasjon",
        "Bolter/fester stramme uten korrosjon","Bevegelige deler fungerer fritt","Plassering korrekt i forhold til arbeid","Kapasitet/WLL iht. dokumentasjon"
      ],
      "EN362 – Koblingsstykke / Karabiner":[
        "Merkelapp/merking lesbar – EN362","Låsemekanisme fungerer – åpner/lukker korrekt",
        "Fjærspenning normal – lukker automatisk","Ingen rust/riper/deformasjoner","Funksjon uten fastklemming"
      ],
      "EN341 – Nedfirings- / Redningsutstyr":[
        "Merkelapp/sertifikat lesbar – EN341","Hus/mekanisme uten skade/korrosjon",
        "Tau/wire uten skader/rifter/knekk","Bremsemekanisme fungerer under test",
        "Kroker/karabiner intakte og funksjonelle","Lengde samsvarer med spesifikasjon","Kontrolldato oppdatert"
      ]
    };
    let PRODUCT_TYPES = Object.keys(CHECKLISTS);

    // ===== UI atoms =====
    const Button   = (p)=>React.createElement("button",{className:"btn",...p}, p.children);
    const BtnSec   = (p)=>React.createElement("button",{className:"btn secondary",...p}, p.children);
    const BtnDanger= (p)=>React.createElement("button",{className:"btn danger",...p}, p.children);
    const Card = ({title,children,actions,style}) =>
      React.createElement("div",{className:"card",style},
        title ? React.createElement("h3",null,title) : null,
        children,
        actions ? React.createElement("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"}}, actions) : null
      );
    const L       = (t)=>React.createElement("div",{className:"label"}, t);
    const Input   = (p)=>React.createElement("input",{className:"input",...p});
    const TextArea= (p)=>React.createElement("textarea",{className:"input",...p});
    const Select  = ({children, ...p})=>React.createElement("select",{className:"input",...p}, children);

    // RÅ select for produkttyper
    function ProductTypeSelect({ value, onChange }) {
      return React.createElement(
        "select",
        { className: "input", value, onChange },
        [
          React.createElement("option", { key: "0", value: "" }, "Velg …"),
          ...PRODUCT_TYPES.map((t) =>
            React.createElement("option", { key: t, value: t }, t)
          ),
        ]
      );
    }

    // Radio-bokser for OK/Anmerking per punkt
    function StatusBoxes({ name, value, onChange }) {
      return React.createElement("div",{className:"choices"},
        React.createElement("div",{className:"choice ok"},
          React.createElement("input",{
            id:`${name}-ok`, type:"radio", name, value:"OK", checked:value==="OK",
            onChange:()=>onChange("OK")
          }),
          React.createElement("label",{htmlFor:`${name}-ok`}, "OK")
        ),
        React.createElement("div",{className:"choice warn"},
          React.createElement("input",{
            id:`${name}-anm`, type:"radio", name, value:"Anmerking", checked:value==="Anmerking",
            onChange:()=>onChange("Anmerking")
          }),
          React.createElement("label",{htmlFor:`${name}-anm`}, "Anmerking")
        )
      );
    }

    // Radio-bokser for Resultat (OK / Underkjent)
    function ResultBoxes({ value, onChange }) {
      return React.createElement("div",{className:"choices"},
        React.createElement("div",{className:"choice ok"},
          React.createElement("input",{
            id:`res-ok`, type:"radio", name:"res", value:"OK", checked:value==="OK",
            onChange:()=>onChange("OK")
          }),
          React.createElement("label",{htmlFor:`res-ok`}, "OK")
        ),
        React.createElement("div",{className:"choice warn"},
          React.createElement("input",{
            id:`res-ukjent`, type:"radio", name:"res", value:"Underkjent", checked:value==="Underkjent",
            onChange:()=>onChange("Underkjent")
          }),
          React.createElement("label",{htmlFor:`res-ukjent`}, "Underkjent")
        )
      );
    }

    // ===== Views =====
    function CustomersView({db,cust,setCust,setView,setCurrentCustomer,exportBackup,importBackup,addCustomer,address,updateCustomer,deleteCustomer}) {
      return e("div",{className:"grid two"},
        e(Card,{title:"Kunder"},
          e("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginBottom:8}},
            e(BtnSec,{onClick:exportBackup},"Eksporter backup (JSON)"),
            e("label",{className:"btn secondary",style:{display:"inline-flex",alignItems:"center",gap:8,cursor:"pointer"}},
              "Importer backup",
              e("input",{type:"file",accept:"application/json",style:{display:"none"},
                onChange:ev=>{const f=ev.target.files&&ev.target.files[0]; if(f) importBackup(f);}})
            )
          ),
          db.customers.length===0?e("div",{className:"small"},"Ingen kunder enda."):null,
          e("ul",{style:{listStyle:"none",padding:0,margin:0}},
            db.customers.map(c=>e("li",{key:c.id,className:"kundeitem"},
              e("div",{onClick:()=>{setCurrentCustomer(c); setView("customerDetail");},style:{cursor:"pointer"}},
                e("div",{style:{fontWeight:800}},c.name),
                e("div",{className:"small"}, address(c)),
                e("div",{className:"small"},`Kontakt: ${c.contact||"-"} · ${c.phone||"-"}`)
              ),
              e("div",{style:{display:"flex",gap:6}},
                e(BtnSec,{onClick:()=>{const name=prompt("Kundenavn",c.name); if(name===null)return;
                  const contact=prompt("Kontaktperson",c.contact||""); if(contact===null)return;
                  const phone=prompt("Telefon",c.phone||""); if(phone===null)return;
                  const email=prompt("E-post",c.email||""); if(email===null)return;
                  const orgnr=prompt("Org.nr",c.orgnr||""); if(orgnr===null)return;
                  const street=prompt("Gateadresse",c.street||""); if(street===null)return;
                  const zip=prompt("Postnr",c.zip||""); if(zip===null)return;
                  const city=prompt("Poststed",c.city||""); if(city===null)return;
                  updateCustomer({...c,name,contact,phone,email,orgnr,street,zip,city});
                }},"Rediger"),
                e(BtnDanger,{onClick:()=>deleteCustomer(c.id)},"Slett")
              )
            ))
          )
        ),
        e(Card,{title:"Ny kunde"},
          e("div",{className:"row three"},
            e("div",null,L("Kundenavn"),Input({value:cust.name,onChange:ev=>setCust({...cust,name:ev.target.value})})),
            e("div",null,L("Kontaktperson"),Input({value:cust.contact,onChange:ev=>setCust({...cust,contact:ev.target.value})})),
            e("div",null,L("Telefon"),Input({value:cust.phone,onChange:ev=>setCust({...cust,phone:ev.target.value})}))
          ),
          e("div",{className:"row three"},
            e("div",null,L("E-post"),Input({value:cust.email,onChange:ev=>setCust({...cust,email:ev.target.value})})),
            e("div",null,L("Org.nr"),Input({value:cust.orgnr,onChange:ev=>setCust({...cust,orgnr:ev.target.value})}))
          ),
          e("div",{className:"row three"},
            e("div",null,L("Gateadresse"),Input({value:cust.street,onChange:ev=>setCust({...cust,street:ev.target.value})})),
            e("div",null,L("Postnr"),Input({value:cust.zip,onChange:ev=>setCust({...cust,zip:ev.target.value})})),
            e("div",null,L("Poststed"),Input({value:cust.city,onChange:ev=>setCust({...cust,city:ev.target.value})}))
          ),
          e("div",{style:{marginTop:10}}, e("button",{className:"btn",onClick:addCustomer},"Lagre kunde"))
        )
      );
    }

    function CustomerDetailView({
      db,currentCustomer,setView,ind,setInd,addIndividual,cleanType,setCurrentIndividual,
      updateIndividual,deleteIndividual,address,exportPdf,deleteCheck, startChecklist,
      bundleFrom,bundleTo,setBundleFrom,setBundleTo,exportCustomerBundle,mailCustomerBundle
    }) {
      const inds=db.individuals.filter(i=>i.customerId===currentCustomer.id);
      const checks=db.checks.filter(y=>inds.some(i=>i.id===y.individualId)).sort((a,b)=>b.date.localeCompare(a.date));
      return e("div",{className:"grid two"},
        e(Card,{title:"Kunde"},
          e("div",{style:{fontWeight:800,fontSize:18}}, currentCustomer.name),
          e("div",{className:"small"}, address(currentCustomer)),
          e("div",{className:"small"}, `Kontakt: ${currentCustomer.contact||"-"} · ${currentCustomer.phone||"-"}`),
          e("div",{className:"small"}, `E-post: ${currentCustomer.email||"-"} · Org.nr: ${currentCustomer.orgnr||"-"}`),
          e("div",{className:"divider"}),
          e(BtnSec,{onClick:()=>setView("customers")},"Tilbake"),
          e("div",{className:"divider"}),
          e("div",null, e("strong",null,"Samlerapport (PDF)")),
          e("div",{className:"row two",style:{marginTop:8}},
            e("div",null, L("Fra dato"), Input({type:"date",value:bundleFrom,onChange:ev=>setBundleFrom(ev.target.value)})),
            e("div",null, L("Til dato"),  Input({type:"date",value:bundleTo,onChange:ev=>setBundleTo(ev.target.value)}))
          ),
          e("div",{style:{display:"flex",gap:8,marginTop:8}},
            e(Button,{onClick:()=>exportCustomerBundle(currentCustomer,bundleFrom,bundleTo)},"Lag samlerapport"),
            e(BtnSec,{onClick:()=>mailCustomerBundle(currentCustomer,bundleFrom,bundleTo)},"Lag og åpne e-post")
          )
        ),
        e(Card,{title:"Legg til individ"},
          e("div",{className:"row two"},
            e("div",null,L("Navn / betegnelse"),Input({value:ind.name,onChange:ev=>setInd({...ind,name:ev.target.value})})),
            e("div",null,L("Serienummer"),Input({value:ind.serial,onChange:ev=>setInd({...ind,serial:ev.target.value})}))
          ),
        </script>
```0